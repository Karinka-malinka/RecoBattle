# Техническое задание

## Система сравнения сервисов ASR "RecoBattle"

---

### Общие требования

Система представляет собой HTTP API со следующими требованиями к бизнес-логике:

* регистрация, аутентификация и авторизация пользователей;
* приём wav-файлов для распознавания от зарегистрированных пользователей;
* учёт и ведение списка переданных и распознанных wav-файлов зарегистрированного пользователя;
* учёт и ведение распознанных данных из wav-файла зарегистрированного пользователя;
* ввод эталонного текста разговора зарегистрированным пользователем для оценки качества распознавания
* проверка качества распознавания;

### Абстрактная схема взаимодействия с системой

Ниже представлена абстрактная бизнес-логика взаимодействия пользователя с системой:

1. Пользователь регистрируется в системе сравнения сервисов ASR «RecoBattle».
2. Пользователь загружает wav-файл для распознавания и выбирает сервис ASR из доступных для распознавания.
3. Wav-файл попадает в систему, разделяется на 2 аудио-канала, каждый канал разделяется на семплы по паузам, семплы отправляются в выбранный сервис ASR.
4. Пользователю возвращается статус успешного приема файла, результат распознавания возвращается позже.
5. Пользователь вводит текст разговора, который фиксируется как эталонный для проверки качества.
6. При наличии результата распознавания и эталонного текста происходит оценка качества распознавания.
7. Пользователь может "поделиться" распознанным файлом.\
   
### Сервис ASR

Сервис ASR является внешним сервисом. Он работает по принципу чёрного ящика и недоступен для инспекции внешними клиентами. В зависимости от выбранного сервиса ASR формируется определенный пакет данных для отправки с конвертацией аудио-файла в нужный сервису формат.

Протоколы взаимодействия с сервиса будут описаны отдельно при их реализации.

### Сводное HTTP API

Накопительная система лояльности «Гофермарт» должна предоставлять следующие HTTP-хендлеры:

* `POST /api/user/register` — регистрация пользователя;
* `POST /api/user/login` — аутентификация пользователя;
* `POST /api/user/audiofile` — загрузка пользователем wav-файла для распознавания;
* `GET /api/user/audiofiles` — получение списка загруженных пользователем wav-файлов, статусов их обработки;
* `GET /api/user/textfile` — получение текстового результата от ASR;
* `POST /api/user/ideal` — загрузка эталонного текста разговора для оценки качества;
* `GET /api/user/qualitycontrol` — получение информации о качестве распознавания.

### Общие ограничения и требования

* хранилище данных — PostgreSQL;
* структура таблиц остаётся на усмотрение студента;
* типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остаётся на усмотрение студента;
* клиент может поддерживать HTTP-запросы/ответы со сжатием данных;
* клиент обязан делать запросы соответственно нижеизложенной спецификации API
* формат и алгоритм проверки аутентификации и авторизации пользователя остаётся на усмотрение студента;
* номера загруженных файлов уникальны и никогда не повторяются;
* один и тот же файл может быть принят в обработку только один раз для одного и тоже же сервиса ASR от одного пользователя;
* файл может не иметь никакого распознавания и оценки качества;
  
#### **Регистрация пользователя**

Хендлер: `POST /api/user/register`.

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным.
После успешной регистрации должна происходить автоматическая аутентификация пользователя.

Формат запроса:

```
POST /api/user/register HTTP/1.1
Content-Type: application/json
...

{
	"login": "<login>",
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` — пользователь успешно зарегистрирован и аутентифицирован;
- `400` — неверный формат запроса;
- `409` — логин уже занят;
- `500` — внутренняя ошибка сервера.

#### **Аутентификация пользователя**

Хендлер: `POST /api/user/login`.

Аутентификация производится с помощью jwt
Формат запроса:

```
POST /api/user/login HTTP/1.1
Content-Type: application/json
Authorization: Bearer ${access_token}"
...
```

Возможные коды ответа:

- `200` — пользователь успешно аутентифицирован;
- `400` — неверный формат запроса;
- `401` — невалидный токен
- `500` — внутренняя ошибка сервера.

#### **Загрузка пользователем wav-файла для распознавания**

Хендлер: `POST /api/user/audiofile`.

Хендлер доступен только аутентифицированным пользователям. 
Формат запроса:

```
POST /api/user/orders HTTP/1.1
Content-Type: application/json
...
{
	"asr": "<asr>",
	"file_name": "<file_name>",
	"audio": "<audio>"
}
```

Возможные коды ответа:

- `200` — wav-файла уже был загружен этим пользователем;
- `202` — новый wav-файла принят в обработку;
- `400` — неверный формат запроса;
- `401` — пользователь не аутентифицирован;
- `409` — номер заказа уже был загружен другим пользователем;
- `422` — неверный формат ASR или типа аудио-файла;
- `500` — внутренняя ошибка сервера.

#### **Получение списка загруженных пользователем wav-файлов**

Хендлер: `GET /api/user/audiofiles`.

Хендлер доступен только авторизованному пользователю. ID wav-файлов в выдаче должны быть отсортированы по времени загрузки от самых новых к самым старым. Формат даты — RFC3339.

Доступные статусы обработки расчётов:

- `NEW` — заказ загружен в систему, но не попал в обработку;
- `PROCESSING` — происходит распознование;
- `INVALID` — система ASR не смогла корректно обработать файл;
- `PROCESSED` — данные по распознованию успешно получены.

Формат запроса:

```
GET /api/user/orders HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
    	{
            "id_file": "123e4567-e89b-12d3-a456-426655440000",
    	    "file_name" : "rec 1",
            "status": "PROCESSED",
            "uploaded_at": "2020-12-10T15:15:45+03:00"
        },
        {
            "id_file": "345e4567-e89b-12d3-a456-426652340000",
            "file_name" : "rec 2",
            "status": "PROCESSING",
            "uploaded_at": "2020-12-10T15:12:01+03:00"
        },
        {
    	    "id_file": "765e4567-e89b-12d3-a456-426652340000",
            "file_name" : "rec 3",
            "status": "INVALID",
            "uploaded_at": "2020-12-09T16:09:53+03:00"
        }
    ]
    ```

- `204` — нет данных для ответа.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **Загрузка эталонного текста разговора для оценки качества**

Хендлер: `GET /api/user/balance`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о текущей сумме баллов лояльности, а также сумме использованных за весь период регистрации баллов.

Формат запроса:

```
GET /api/user/balance HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
    	"current": 500.5,
    	"withdrawn": 42
    }
    ```

- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **Запрос на списание средств**

Хендлер: `POST /api/user/balance/withdraw`

Хендлер доступен только авторизованному пользователю. Номер заказа представляет собой гипотетический номер нового заказа пользователя в счет оплаты которого списываются баллы.

Примечание: для успешного списания достаточно успешной регистрации запроса, никаких внешних систем начисления не предусмотрено и не требуется реализовывать.

Формат запроса:

```
POST /api/user/balance/withdraw HTTP/1.1
Content-Type: application/json

{
	"order": "2377225624",
    "sum": 751
}
```

Здесь `order` — номер заказа, а `sum` — сумма баллов к списанию в счёт оплаты.

Возможные коды ответа:

- `200` — успешная обработка запроса;
- `401` — пользователь не авторизован;
- `402` — на счету недостаточно средств;
- `422` — неверный номер заказа;
- `500` — внутренняя ошибка сервера.

#### **Получение информации о выводе средств**

Хендлер: `GET /api/user/withdrawals`.

Хендлер доступен только авторизованному пользователю. Факты выводов в выдаче должны быть отсортированы по времени вывода от самых новых к самым старым. Формат даты — RFC3339.

Формат запроса:

```
GET /api/user/withdrawals HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "order": "2377225624",
            "sum": 500,
            "processed_at": "2020-12-09T16:09:57+03:00"
        }
    ]
    ```

- `204` - нет ни одного списания.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

### Взаимодействие с системой расчёта начислений баллов лояльности

Для взаимодействия с системой доступен один хендлер:

- `GET /api/orders/{number}` — получение информации о расчёте начислений баллов лояльности.

Формат запроса:

```
GET /api/orders/{number} HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
        "order": "<number>",
        "status": "PROCESSED",
        "accrual": 500
    }
    ```

  Поля объекта ответа:

    - `order` — номер заказа;
    - `status` — статус расчёта начисления:

        - `REGISTERED` — заказ зарегистрирован, но не начисление не рассчитано;
        - `INVALID` — заказ не принят к расчёту, и вознаграждение не будет начислено;
        - `PROCESSING` — расчёт начисления в процессе;
        - `PROCESSED` — расчёт начисления окончен;

    - `accrual` — рассчитанные баллы к начислению, при отсутствии начисления — поле отсутствует в ответе.

- `204` - заказ не зарегистрирован в системе расчета.

- `429` — превышено количество запросов к сервису.

  Формат ответа:

    ```
    429 Too Many Requests HTTP/1.1
    Content-Type: text/plain
    Retry-After: 60
    
    No more than N requests per minute allowed
    ```

- `500` — внутренняя ошибка сервера.

Заказ может быть взят в расчёт в любой момент после его совершения. Время выполнения расчёта системой не регламентировано. Статусы `INVALID` и `PROCESSED` являются окончательными.

Общее количество запросов информации о начислении не ограничено.

### Конфигурирование сервиса накопительной системы лояльности

Сервис должн поддерживать конфигурирование следующими методами:

- адрес и порт запуска сервиса: переменная окружения ОС `RUN_ADDRESS` или флаг `-a`
- адрес подключения к базе данных: переменная окружения ОС `DATABASE_URI` или флаг `-d`
- адрес системы расчёта начислений: переменная окружения ОС `ACCRUAL_SYSTEM_ADDRESS` или флаг `-r`
