# Техническое задание

## Система сравнения сервисов ASR "RecoBattle"

---

### Общие требования

Система представляет собой HTTP API со следующими требованиями к бизнес-логике:

* регистрация, аутентификация и авторизация пользователей;
* приём wav-файлов для распознавания от зарегистрированных пользователей;
* учёт и ведение списка переданных и распознанных wav-файлов зарегистрированного пользователя;
* учёт и ведение распознанных данных из wav-файла зарегистрированного пользователя;
* ввод эталонного текста разговора зарегистрированным пользователем для оценки качества распознавания
* проверка качества распознавания;

### Абстрактная схема взаимодействия с системой

Ниже представлена абстрактная бизнес-логика взаимодействия пользователя с системой:

1. Пользователь регистрируется в системе сравнения сервисов ASR «RecoBattle».
2. Пользователь загружает wav-файл для распознавания и выбирает сервис ASR из доступных для распознавания.
3. Wav-файл попадает в систему, разделяется на 2 аудио-канала, каждый канал разделяется на семплы по паузам, семплы отправляются в выбранный сервис ASR.
4. Пользователю возвращается статус успешного приема файла, результат распознавания возвращается позже.
5. Пользователь вводит текст разговора, который фиксируется как эталонный для проверки качества.
6. При наличии результата распознавания и эталонного текста происходит оценка качества распознавания.
7. Пользователь может "поделиться" распознанным файлом.\
   
### Сервис ASR

Сервис ASR является внешним сервисом. Он работает по принципу чёрного ящика и недоступен для инспекции внешними клиентами. В зависимости от выбранного сервиса ASR формируется определенный пакет данных для отправки с конвертацией аудио-файла в нужный сервису формат.

Протоколы взаимодействия с сервиса будут описаны отдельно при их реализации.

### Сводное HTTP API

Система сравнения сервисов ASR "RecoBattle" должна предоставлять следующие HTTP-хендлеры:

* `POST /api_public/user/register` — регистрация пользователя;
* `POST /api_public/user/login` — аутентификация пользователя;
* `POST /api_private/user/audiofile` — загрузка пользователем wav-файла для распознавания;
* `GET /api_private/user/audiofiles` — получение списка загруженных пользователем wav-файлов, статусов их обработки;
* `GET /api_private/user/textfile/{uuid}` — получение текстового результата от ASR;
* `POST /api_private/user/ideal` — загрузка эталонного текста разговора для оценки качества;
* `GET /api_private/user/qualitycontrol/{id_file}` — получение информации о качестве распознавания.

### Общие ограничения и требования

* хранилище данных — PostgreSQL;
* структура таблиц остаётся на усмотрение студента;
* типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остаётся на усмотрение студента;
* клиент может поддерживать HTTP-запросы/ответы со сжатием данных;
* клиент обязан делать запросы соответственно нижеизложенной спецификации API
* формат и алгоритм проверки аутентификации и авторизации пользователя остаётся на усмотрение студента;
* номера загруженных файлов уникальны и никогда не повторяются;
* один и тот же файл может быть принят в обработку только один раз для одного и тоже же сервиса ASR от одного пользователя;
* файл может не иметь никакого распознавания и оценки качества;
  
#### **Регистрация пользователя**

Хендлер: `POST /api_public/user/register`.

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным.
После успешной регистрации должна происходить автоматическая аутентификация пользователя.

Формат запроса:

```
POST /api_public/user/register HTTP/1.1
Content-Type: application/json
...

{
	"login": "<login>",
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` — пользователь успешно зарегистрирован и аутентифицирован;
- `400` — неверный формат запроса;
- `409` — логин уже занят;
- `500` — внутренняя ошибка сервера.

#### **Аутентификация пользователя**

Хендлер: `POST /api_public/user/login`.

Аутентификация производится с помощью jwt

Формат запроса:

```
POST /api_public/user/login HTTP/1.1
Content-Type: application/json
...

{
    "login": "<login>",
    "password": "<password>"
} 
```

Возможные коды ответа:

- `200` — пользователь успешно аутентифицирован;
- `400` — неверный формат запроса;
- `401` — неверная пара логин/пароль;
- `500` — внутренняя ошибка сервера.

#### **Загрузка пользователем wav-файла для распознавания**

Хендлер: `POST /api_private/user/audiofile`.

Хендлер доступен только аутентифицированным пользователям. 
Формат запроса:

```
POST /api_private/user/audiofile HTTP/1.1
Content-Type: application/json
Authorization: Bearer ${access_token}
...
{
	"asr": "<asr>",
	"file_name": "<file_name>",
	"audio": "<audio>"
}
```

Возможные коды ответа:

- `200` — wav-файл уже был загружен этим пользователем;
- `202` — новый wav-файл принят в обработку;
- `400` — неверный формат запроса;
- `401` — пользователь не аутентифицирован;
- `422` — неверный формат ASR или типа аудио-файла;
- `500` — внутренняя ошибка сервера.

#### **Получение списка загруженных пользователем wav-файлов**

Хендлер: `GET /api_private/user/audiofiles`.

Хендлер доступен только авторизованному пользователю. ID wav-файлов в выдаче должны быть отсортированы по времени загрузки от самых новых к самым старым. Формат даты — RFC3339.

Доступные статусы обработки расчётов:

- `NEW` — заказ загружен в систему, но не попал в обработку;
- `PROCESSING` — происходит распознование;
- `INVALID` — система ASR не смогла корректно обработать файл;
- `PROCESSED` — данные по распознованию успешно получены.

Формат запроса:

```
GET /api_private/user/audiofiles HTTP/1.1
Content-Length: 0
Authorization: Bearer ${access_token}
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "uuid": "6663e4567-e89b-12d3-a456-426655440000",
            "id_file": "123e4567-e89b-12d3-a456-426655440000",
            "file_name" : "rec 1",
            "asr" : "yandexSpeachKit",
            "status": "PROCESSED",
            "uploaded_at": "2020-12-10T15:15:45+03:00"
        },
        {
            "uuid": "8883e4567-e89b-12d3-a456-426655440000",
            "id_file": "123e4567-e89b-12d3-a456-426655440000",
            "file_name" : "rec 1",
            "asr" : "vosk",
            "status": "PROCESSING",
            "uploaded_at": "2020-12-10T15:12:01+03:00"
        },
        {
            "uuid": "4444e4567-e89b-12d3-a456-426655440000",
            "id_file": "765e4567-e89b-12d3-a456-426652340000",
            "file_name" : "rec 2",
            "asr" : "3iTech",
            "status": "INVALID",
            "uploaded_at": "2020-12-09T16:09:53+03:00"
        }
    ]
    ```

- `204` — нет данных для ответа.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **Получение текстового результата от ASR**

Хендлер: `GET /api_private/user/textfile/{uuid}`.

Хендлер доступен только авторизованному пользователю. ID реплик в выдаче должны быть отсортированы по времени возникновения от самых старых к самым новым.

Формат запроса:

```
GET /api_private/user/textfile/6663e4567-e89b-12d3-a456-426655440000 HTTP/1.1
Content-Length: 0
Authorization: Bearer ${access_token}
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "channelTag" : "1",
            "text" : "добрый день",
            "startTime": 0.879999999
            "endTime": 1.159999992
        },
        {
            "channelTag" : "2",
            "text" : "здравствуйте",
            "startTime": 1.219999995
            "endTime": 1.539999988
        },
    	{
            "channelTag" : "1",
            "text" : "у меня вопрос про мой остаток на счету",
            "startTime": 1.739999988
            "endTime": 3.539999988
        },
    	...
    ]
    ```

- `204` — нет данных для ответа.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.
  
#### **Загрузка эталонного текста разговора для оценки качества**

Хендлер: `POST /api_private/user/ideal`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о текущей сумме баллов лояльности, а также сумме использованных за весь период регистрации баллов.

Формат запроса:

```
POST /api/user/balance/withdraw HTTP/1.1
Content-Type: application/json
Authorization: Bearer ${access_token}

{
    "id_file": "123e4567-e89b-12d3-a456-426655440000",
    "text_channel_1": "Добрый день. У меня вопрос про мой остаток на счету..."
    "text_channel_2": "Здравствуйте..."
}
```

Возможные коды ответа:

- `200` — успешная обработка запроса;
- `401` — пользователь не авторизован;
- `409` — эталонный текст был загружен ранее;
- `422` — неверный id файла;
- `500` — внутренняя ошибка сервера.

#### **Получение информации о качестве распознавания**

Хендлер: `GET /api_private/user/qualitycontrol/{id_file}` 

Хендлер доступен только авторизованному пользователю.

Формат запроса:

```
GET /api_private/user/qualitycontrol/123e4567-e89b-12d3-a456-426655440000 HTTP/1.1
Content-Length: 0
Authorization: Bearer ${access_token}
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "asr": "yandexSpeachKit",
            "quality": 99,
        },
        {
            "asr": "vosk",
            "quality": 60,
        }
    ]
    ```

- `204` - нет данных о распозновании или нет эталонного текста.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

### Конфигурирование сервиса

Сервис должн поддерживать конфигурирование следующими методами:

- адрес и порт запуска сервиса: переменная окружения ОС `RUN_ADDRESS` или флаг `-a`
- адрес подключения к базе данных: переменная окружения ОС `DATABASE_URI` или флаг `-d`
- адрес файла config.toml с данными для подключения к сервисам ASR: переменная окружения ОС `CONFIG_ASR` или флаг `-c`
